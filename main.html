<!doctype html>
<html>
	<head>
		<title>HotHotHot</title>
        <link rel="stylesheet" href="../Projet-js-HotHotHot/style.css">
		<script src="package/dist/chart.js"></script>
		<meta charset="utf-8"/>
	</head>
	<body>
		<div class="container">

			<!-- Menu de navigation -->
			<nav>
				<button id="menu" onclick="toggleMenu()">Menu</button>
				<ul id="menu-box" role="tablist">
					<li role="tab"><a href="#temp">Température</a></li>
					<li role="tab"><a href="#histo">Historique</a></li>
					<li role="tab"><a href="#login">Se connecter</a></li>
					<li role="tab"><a href="#doc">Documentation</a></li>
				</ul>
			</nav>

			<!-- Section Accueil -->
			<section id="acceuil">
				<h1>HotHotHot</h1>
				<p> Bonjour, Bienvenue sur notre site ! </p>
			</section>

			<!-- SECTION TEMPERATURE -->
        	<section role="tabpanel" class='active' id="temp">
				<p id="p_temperature_ext">Affichage de la température extérieure: <span aria-live="assertive" id="span_temperature_ext"></span></p>
            	<p id="p_temperature_int">Affichage de la température intérieure: <span aria-live="assertive" id="span_temperature_int"></span></p>
			</section>

			<!-- SECTION HISTORIQUE -->
			<section id="histo" >
				<table role="tabpanel" id="histo">
					<tr><th colspan="2">Historique</th></tr>
					<tr>
						<th>Date</th>
						<th>Température</th>
					</tr>
					<tr id="ligne_modele">
						<td class="td_date"></td>
						<td class="td_temperature"></td>
					</tr>
				</table>
				<div>
					<canvas id="myChart" width="400" height="400">
					</canvas>
				</div>		
			</section>


			<!-- SECTION LOGIN 
			<section role="tabpanel" id="login">
				<p> Test login</p>
			</section> -->
		
			<!-- SECTION DOCUMENTATION -->
			<section role="tabpanel" id="doc">
				<p> Test doc</p>
			</section>

			<!-- BAS DE PAGE -->
			<footer>
				<h4>Bas de page</h4>
			</footer>
		</div>

		<script>
			//Function pour afficher/cacher le menu
            function toggleMenu(){
                const contextMenu = document.getElementById("menu-box");
                if(contextMenu.style.display == "block"){
                    contextMenu.style.display = "none";
                }
                else{
                    contextMenu.style.display = "block"
                }
            }
            
			//Systemes d'onglets
            Array.from(document.querySelectorAll('nav ul li a')).forEach(function(element_a) {
				element_a.addEventListener('click', 
					function(event) {
						Array.from(document.querySelectorAll('.active')).forEach(function(element_section_ou_table) {
							element_section_ou_table.removeAttribute('class');
						});
						let element_a_id = event.target.attributes.href.value.replace('#', '');
						document.getElementById(element_a_id).setAttribute('class', 'active');
					}
				);
			});

			// Gestion du WSS si il fonctionne ou gestion de l'API 

			var socket = new WebSocket('wss://ws.hothothot.dog:9502');
            socket.onopen = function(event) {
                console.log("Connexion établie");

                socket.send("test");

                socket.onmessage = function(event){
                    console.log(event.data);
                }	
            }
			if(socket.readyState != 1){
				fetch("https://hothothot.dog/api/capteurs",
				{
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					method: "GET",
				})
				.then(function(response){
					return response.json().then(function(O_json){
						console.log(O_json);
						console.log(O_json.capteurs.nom['interieur'].valeur)
						})
					})	
				}

				
			// Afficher les alertes et les valeurs des capteurs
			(function() {
		
				
				// https://developer.mozilla.org/fr/docs/Web/API/Document_Object_Model
				// https://developer.mozilla.org/fr/docs/Web/API/Node
				// https://developer.mozilla.org/fr/docs/Web/API/Element
				var p_temperature_ext = document.getElementById('p_temperature_ext');
                var p_temperature_int = document.getElementById('p_temperature_int');

				var section_ext = p_temperature_ext.parentNode;
                var section_int = p_temperature_int.parentNode;

				var span_temperature_ext =  document.getElementById('span_temperature_ext');
                var span_temperature_int = document.getElementById('span_temperature_int');
				var i = 0;

				// https://developer.mozilla.org/en-US/docs/Web/API/setInterval
				var interval = setInterval(function() {
					if(i < A_temperatures.length) {
						if(document.getElementById('titre_message_int')) document.getElementById('titre_message_int').remove();
						if(document.getElementById('titre_message_ext')) document.getElementById('titre_message_ext').remove();	

						let I_temperature = A_temperatures[i];
						
						let color = 'blue';
						if( 0 < I_temperature && I_temperature <= 20 ) {
							color = 'green';
						}
						else if( 20 < I_temperature && I_temperature <= 30 ) {
							color = 'orange';
						}
						else if( 30 < I_temperature && I_temperature <= 40 ) {
							color = 'red';
						}
						
						++i;

                        span_temperature_int.setAttribute("class", color);
                        span_temperature_int.innerText = I_temperature;

						span_temperature_ext.setAttribute("class", color);
						span_temperature_ext.innerText = I_temperature;
						
                        let titre_message_int = document.createElement("h4");
                        titre_message_int.setAttribute('id', 'titre_message_int');

                        if( 22 < I_temperature) {
							titre_message_int.innerText = 'Baissez le chauffage !';
						} 
						else if ( 50 < I_temperature ) {
							titre_message_int.innerText = 'Appelez les pompiers ou arrêtez votre barbecue !';
						}
                        else if ( 12 > I_temperature ) {
							titre_message_int.innerText = 'Montez le chauffage ou mettez un gros pull  !';
						}
                        else if ( 0 > I_temperature ) {
							titre_message_int.innerText = 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !';
						}

						let titre_message_ext = document.createElement("h4");
						titre_message_ext.setAttribute('id', 'titre_message_ext');
						if( I_temperature < 0 ) {
							titre_message_ext.innerText = 'Banquise en vue !';
						} 
						else if ( 35 < I_temperature ) {
							titre_message_ext.innerText = 'Hot Hot Hot !';
						}
						// https://developer.mozilla.org/fr/docs/Web/API/Node/insertBefore
						section_ext.insertBefore(titre_message_ext, p_temperature_ext); 
                        section_int.insertBefore(titre_message_int, p_temperature_int);

						let clone_historique_ligne = document.getElementById("ligne_modele").cloneNode(true);
						clone_historique_ligne.setAttribute("id", "");	
						clone_historique_ligne.querySelector(".td_date").innerText = Date().toString();
						clone_historique_ligne.querySelector(".td_temperature").innerText = I_temperature;
						clone_historique_ligne.style.visibility = "visible";
						let table_tbody = document.querySelector("table tbody");
						// https://developer.mozilla.org/fr/docs/Web/API/Node/insertBefore
						table_tbody.insertBefore(clone_historique_ligne, table_tbody.querySelector("#ligne_modele").nextSibling);

					} else {
						clearInterval(interval);
						interval = null;
					}
				}, 2000)
			}());


			


			function getDate(){
				return d = new Date();
			}


		</script>
		
		<script>

			//Création du graphique 
			var canvas = document.getElementById("myChart");
			var data = {
				labels: ["0h", "2h", "4h", "6h", "8h", "10h", "12h"],
				datasets: [
					{
						label: 'My First dataset',
						backgroundColor: 'rgb(255, 99, 132)',
						borderColor: 'rgb(255, 99, 132)',
						data: [0, 10, 5, 2, 20, 30, 45],
					}
				]
			};
			
			var option = {
				showLines: true,
				responsive: false
			};

			const config = {
				type: 'line',
				data: data,
				options: option
			};

			const myChart = new Chart(document.getElementById("myChart"), config);

			//Ajout d'une valeur au graphe
			function adddata(){
				myLineChart.data.datasets[0].data[7] = getRandomArbitrary(0, 30);
				myLineChart.data.labels[7] = "Newly added";
				myLineChart.update();
			}
		</script>
	</body>
</html>