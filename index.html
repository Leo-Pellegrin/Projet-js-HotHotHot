<!doctype html>
<html>
	<head>
		<title>HotHotHot</title>
        
		<script src="package/dist/chart.js"></script>

		<link rel="stylesheet" href="style.css">
		<link rel="manifest" href="manifest.json">
		<link rel="apple-touch-icon" href="/assets/images/android-chrome-192x192.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
        <link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg" color="#5bbad5">

        <meta name="msapplication-TileColor" content="#00aba9">
        <meta name="theme-color" content="#90EE90">
		<meta name="viewport" content="width=device-width, initial-scale=0.86, maximum-scale=5.0, minimum-scale=0.86">
		<meta charset="utf-8"/>
	</head>
	<body>
		<script src="src/index.js"></script>
		<div class="container">

			<!-- Menu de navigation -->
			<nav>
				<button id="menu" onclick="toggleMenu()">Menu</button>
				<ul id="menu-box" role="tablist">
					<li role="tab"><a href="#temp">Température</a></li>
					<li role="tab"><a href="#histo">Historique</a></li>
					<li role="tab"><a href="contact.html">Se connecter</a></li>
					<li role="tab"><a href="#doc">Documentation</a></li>
				</ul>
			</nav>

			<!-- Section Accueil -->
			<section id="acceuil">
				<h1>HotHotHot</h1>
				<p> Bonjour, Bienvenue sur notre site ! </p>
			</section>

			<!-- SECTION TEMPERATURE -->
        	<section role="tabpanel" class='active' id="temp">
				<p id="p_temperature_ext">Affichage de la température extérieure: <span aria-live="assertive" id="span_temperature_ext"></span></p>
            	<p id="p_temperature_int">Affichage de la température intérieure: <span aria-live="assertive" id="span_temperature_int"></span></p>
				<div id="ValeurMaxMinInt">
					<p id="MaxInt">Value Maximale Intérieure: <span aria-live="assertive" id="span_tempmax_int"></span></p> 
					<p id="MinInt">Value Minimale Intérieure: <span aria-live="assertive" id="span_tempmin_int"></span></p> 
				</div>	
				<div id="ValeurMaxMinExt">
					<p id="MaxExt">Value Maximale Extérieure: <span aria-live="assertive" id="span_tempmax_ext"></span></p> 
					<p id="MinExt">Value Minimale Extérieure: <span aria-live="assertive" id="span_tempmin_ext"></span></p> 
				</div>
				<button onclick="AlerteDialogue()">Voir les notifications</button>
			</section>

			<!-- SECTION HISTORIQUE -->
			<section id="histo" >
				<table role="tabpanel" id="historique">
					<thead>
						<tr><th colspan="2">Historique</th></tr>
						<tr>
							<th>Date</th>
							<th>Température Intérieure</th>
							<th>Température Extérieure</th>
						</tr>
					</thead>
					<tbody id="tbody">
						<tr id="ligne_modele">
							<td class="td_date"></td>
							<td class="td_temperature_int"></td>
							<td class="td_temperature_ext"></td>
						</tr>
					</tbody>
				</table>
				<div id="Graph">
					<canvas id="myChart" width="350" height="400"></canvas>
				</div>
			</section>


			<!-- SECTION LOGIN 
			<section role="tabpanel" id="login">
				<p> Test login</p>
			</section> -->
		
			<!-- SECTION DOCUMENTATION -->
			<section role="tabpanel" id="doc">
			    <h1>Documentation</h3>
			    
			      <h3>Présentation :</h3>
			      
			   <!-- Cadre de présentation -->
			   <div class="cadrepresentation">
			       <!-- Cration de chaque profil -->
			       <div class="profile">
			           <div class="nom">
			               <h4> Léo </h4>
			               <p> Je suis Léo Pellegrin. Rôle: Mise en place de la PWA pour la rendre installable ainsi que de l'API + mise en cache par localStorage</p>
			           </div>
			       </div>  
			       
			       <div class="profile2">
			           <div class="nom">
			               <h4> Kalid </h4>
			               <p> Je suis Kalid Moussa Mohamed. Rôle: Système d'alerte par une boite de dialogue ainsi que la tentative de réalisation de Notifications Push  </p>
			           </div>
			       </div>
			       
			       <div class="profile3">
			           <div class="nom">
			               <h4> Kévin </h4>
			               <p> Je suis Kévin Tan. Rôle: Réalisation du menu de navigation ainsi que de la structure en css + service worker </p>
			           </div>
			       </div>
			       
			       <div class="profile4">
			           <div class="nom">
			               <h4> Mathis </h4>
                        
			           </div>
			           
			           <div class="info">
                          <p> Je suis Mathis Plazi. Rôle: Système d'alerte par une boite de dialogue ainsi que tentative de réalisation des Notifications push </p>
                       </div>   
			       </div>
			   </div>    
			   <h3>Outils et organisations :</h3>
			   <div class="outils">
				   <p>Nous avons principalement utilisé discord pour communiquer entre nous et nous répartir les tâches</p></br>
				   <p>Nous avons aussi créer un Google Docs pour mettre à jour les avancements (<a href="https://docs.google.com/document/d/1t31j1PHHKLpmqquaUZmiNNvmcWGlwONZRy53v4xI280/edit?usp=sharing">lien</a>)</p>
				   <p>L'outil de versionnage GitHub a été aussi très utilisé par l'équipe pour regrouper le travail effectué (<a href="https://github.com/Leo-Pellegrin/Projet-js-HotHotHot">lien</a>)</p>
				   <p>Certaines personnes ont utilisés des dépots différents pour tester et ne pas spammer le dépôt principal</p>
			   </div>
			   <h3>Difficultés rencontrées :</h3>
			   <div class="difficultes">
					<p>La première difficulté rencontrée est le service worker car nous avons des erreurs après qu'il soit mis en place et que son fonctionnement était établie</p>
					<p>Nous n'avons pas réussi à régler ce problème sur le service worker et le téléchargement de l'application en mode hors ligne</p></br>
					<p>La deuxième difficulté rencontrée est la contrainte de temps. Nous avions beaucoup de projet à rendre pendant la même période donc l'organisation était quelque peu compliqué</p>
				</div>
				<h3>Si nous devions recommencer ce projet :</h3>
				<div class="recommencer">
					<p>Les pratiques que nous changerions seraient d'abord l'organisation mais aussi la répartition du temps sur les différents lots proposés dans le sujet. Nous n'avons pas réussi à organiser le temps comme nous l'aurions voulu</p>
				</div>

			       
                    
			   
			      
			    
				
			</section>

			<!-- BAS DE PAGE -->
			<footer>
				<h4>Bas de page</h4>
			</footer>
		</div>

		<script type="text/javascript">

			//Function pour les alertes boite de dialogue
			function AlerteDialogue(){

				var tempint = localStorage.getItem("ValeurInt");
				var tempext = localStorage.getItem("ValeurExt");

				if( 22 < tempint) {
					alert("Baissez le chauffage");
				}
				else if ( 50 < tempint ) {
					alert("Appelez les pompiers ou arrêtez votre barbecue !");
				}
				else if ( 12 > tempint ) {
					alert("Montez le chauffage ou mettez un gros pull  !");
				}
				else if ( 0 > tempint ) {
					alert("Canalisations gelées, appelez SOS plombier et mettez un bonnet !");
				}

				//Système de notification extérieure
				if( tempext < 0 ) {
					alert("Banquise en vue !");
				} 
        		else if ( 35 < tempext ) {
					alert("Hot Hot Hot !");
        		}
			}


			//Function pour afficher/cacher le menu
            function toggleMenu(){
                const contextMenu = document.getElementById("menu-box");
                if(contextMenu.style.display == "block"){
                    contextMenu.style.display = "none";
                }
                else{
                    contextMenu.style.display = "block"
                }
            }
            
			//Systemes d'onglets
            Array.from(document.querySelectorAll('nav ul li a')).forEach(function(element_a) {
				element_a.addEventListener('click', 
					function(event) {
						Array.from(document.querySelectorAll('.active')).forEach(function(element_section_ou_table) {
							element_section_ou_table.removeAttribute('class');
						});
						let element_a_id = event.target.attributes.href.value.replace('#', '');
						document.getElementById(element_a_id).setAttribute('class', 'active');
					}
				);
			});

			//Récupérer les valeurs de l'API
			function getDataAPI(){
				var socket = new WebSocket('wss://ws.hothothot.dog:9502');
            	socket.onopen = function(event) {

                	socket.send("test");

                	socket.onmessage = function(event){
						console.log("Connexion établie", typeof event.data);

                    	valueExt = event.data.capteurs[1][3];
                    	valueInt = event.data.capteurs[0][3];						
                	}	
           	 	}
				if(socket.readyState != 1){
					fetch("https://hothothot.dog/api/capteurs",
					{
						headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json'
						},
						method: "GET",
					})
					.then(function(response){
						response.json().then(data => {
							localStorage.setItem("ValeurInt", data.capteurs[0].Valeur);
							localStorage.setItem("ValeurExt", data.capteurs[1].Valeur);
							localStorage.setItem("TimeStamp", data.capteurs[0].Timestamp);
						})
					})
        		}
			}

			//Création des configs pour les graphique 
			var canvas = document.getElementById("myChartInt");
			var data = {
				labels: [],
				datasets: [
					{
						label: 'Température Extérieure',
						backgroundColor: 'rgb(255, 99, 132)',
						borderColor: 'rgb(255, 99, 132)',
						data: [],
					},
					{
						label: "Température Intérieure",
						backgroundColor: 'rgb(99, 255, 132)',
						borderColor: 'rgb(99, 132, 255)',
						data: [],
					}
				]
			};
			
			var option = {
				showLines: true,
				responsive: false
			};

			const config = {
				type: 'line',
				data: data,
				options: option
			};

			const myChart = new Chart(document.getElementById("myChart"), config);

			var p_temperature_ext = document.getElementById('p_temperature_ext');
			var p_temperature_int = document.getElementById('p_temperature_int');

			var section_ext = p_temperature_ext.parentNode;
			var section_int = p_temperature_int.parentNode;
			
			var span_temperature_ext =  document.getElementById('span_temperature_ext');
			var span_temperature_int = document.getElementById('span_temperature_int');

			var span_tempmax_int = document.getElementById("span_tempmax_int");
			var span_tempmin_int = document.getElementById("span_tempmin_int");
			var span_tempmax_ext = document.getElementById("span_tempmax_ext");
			var span_tempmin_ext = document.getElementById("span_tempmin_ext");

			localStorage.setItem("ValeurMaxInt", 0);
			localStorage.setItem("ValeurMinInt", 50);
			localStorage.setItem("ValeurMaxExt", 0);
			localStorage.setItem("ValeurMinExt", 50);


			// https://developer.mozilla.org/en-US/docs/Web/API/setInterval
			var interval = setInterval(function(){
				if(document.getElementById('titre_message_int')) document.getElementById('titre_message_int').remove();
				if(document.getElementById('titre_message_ext')) document.getElementById('titre_message_ext').remove();	

				getDataAPI();

				var tempint = localStorage.getItem("ValeurInt");
				var tempext = localStorage.getItem("ValeurExt");
				var tempmaxint = localStorage.getItem("ValeurMaxInt");
				var tempminint = localStorage.getItem("ValeurMinInt");
				var tempmaxext = localStorage.getItem("ValeurMaxExt");
				var tempminext = localStorage.getItem("ValeurMinExt");

				if(tempint > tempmaxint){
					localStorage.setItem("ValeurMaxInt", tempint);
				}
				if(tempint < tempminint){
					localStorage.setItem("ValeurMinInt", tempint);
				}
				if(tempext > tempmaxext){
					localStorage.setItem("ValeurMaxExt", tempext);
				}
				if(tempext < tempminext){
					localStorage.setItem("ValeurMinExt", tempext);
				}

				var TimeStamp = localStorage.getItem("TimeStamp");
				var date = new Date(TimeStamp * 1000);

				//Système de couleur pour les températures
				let color = 'blue';

				if( 0 < tempint && tempint <= 20 ) {
					color = 'green';				
				}
				else if( 20 < tempint && tempint <= 30 ) {
					color = 'orange';
				}
				else if( 30 < tempint && tempint <= 40 ) {
					color = 'red';
				}

				span_temperature_int.setAttribute("class", color);
				span_temperature_int.innerText = tempint;

				span_temperature_ext.setAttribute("class", color);
				span_temperature_ext.innerText = tempext;

				span_tempmax_int.innerText = tempmaxint;
				span_tempmin_int.innerText = tempminint;
				span_tempmax_ext.innerText = tempmaxext;
				span_tempmin_ext.innerText = tempminext;


				//Système de notification intérieure
				let titre_message_int = document.createElement("h4");
				titre_message_int.setAttribute('id', 'titre_message_int');

				if( 22 < tempint) {
					titre_message_int.innerText = 'Baissez le chauffage !';
				}
				else if ( 50 < tempint ) {
					titre_message_int.innerText = 'Appelez les pompiers ou arrêtez votre barbecue !';
				}
				else if ( 12 > tempint ) {
					titre_message_int.innerText = 'Montez le chauffage ou mettez un gros pull  !';
				}
				else if ( 0 > tempint ) {
					titre_message_int.innerText = 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !';
				}

				//Système de notification extérieure
				let titre_message_ext = document.createElement("h4");
				titre_message_ext.setAttribute('id', 'titre_message_ext');

				if( tempext < 0 ) {
					titre_message_ext.innerText = 'Banquise en vue !';
				} 
        		else if ( 35 < tempext ) {
            		titre_message_ext.innerText = 'Hot Hot Hot !';
        		}

				//Affichage notification
				section_ext.insertBefore(titre_message_ext, p_temperature_ext); 
				section_int.insertBefore(titre_message_int, p_temperature_int);


				// Gestion de l'historique
				var obj_the_table = document.getElementById("historique");

				if( obj_the_table.rows.length <  8) {
					let clone_historique_ligne = document.getElementById("ligne_modele").cloneNode(true);
					clone_historique_ligne.setAttribute("id", "");	
					clone_historique_ligne.querySelector(".td_date").innerText = Date().toString();
					clone_historique_ligne.querySelector(".td_temperature_int").innerText = tempint;
					clone_historique_ligne.querySelector(".td_temperature_ext").innerText = tempext;
					clone_historique_ligne.style.visibility = "visible";
					let table_tbody = document.querySelector("table tbody");
					// https://developer.mozilla.org/fr/docs/Web/API/Node/insertBefore
					table_tbody.insertBefore(clone_historique_ligne, table_tbody.querySelector("#ligne_modele").nextSibling);
				}
				else{
					let table_tbody = document.querySelector("table tbody");
					for(var i = 2; i < table_tbody.rows.length; i++){
						table_tbody.deleteRow(i);
					}
				}
				// Mise à jour du graphe
				myChart.data.datasets[0].data.push(tempext);
				myChart.data.datasets[1].data.push(tempint);
				myChart.data.labels.push(date.getHours() + ":"+date.getMinutes() + ":"+date.getSeconds());

				if (myChart.data.datasets[0].data.length >= 30){	// Pas plus de 30 valeurs affichée en même temps
					myChart.data.labels = [];
    				myChart.data.datasets.forEach((dataset) => {
        				dataset.data = [];
    				});
				}
				myChart.update();

			}, 2500);

		</script>
	</body>
</html>