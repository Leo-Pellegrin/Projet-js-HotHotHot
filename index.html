<!doctype html>
<html>
	<head>
		<title>HotHotHot</title>
        <link rel="stylesheet" href="style.css">
		<script src="package/dist/chart.js"></script>
		<script src="js/TempModel.js" charset="utf-8"></script>
		<script src="js/TempObserver.js" charset="utf-8"></script>
		<script src="js/AlerteObserver.js" charset="utf-8"></script>
		<meta charset="utf-8"/>
	</head>
	<body>
		<div class="container">

			<!-- Menu de navigation -->
			<nav>
				<button id="menu" onclick="toggleMenu()">Menu</button>
				<ul id="menu-box" role="tablist">
					<li role="tab"><a href="#temp">Température</a></li>
					<li role="tab"><a href="#histo">Historique</a></li>
					<li role="tab"><a href="#login">Se connecter</a></li>
					<li role="tab"><a href="#doc">Documentation</a></li>
				</ul>
			</nav>

			<!-- Section Accueil -->
			<section id="acceuil">
				<h1>HotHotHot</h1>
				<p> Bonjour, Bienvenue sur notre site ! </p>
			</section>

			<!-- SECTION TEMPERATURE -->
        	<section role="tabpanel" class='active' id="temp">
				<p id="p_temperature_ext">Affichage de la température extérieure: <span aria-live="assertive" id="span_temperature_ext"></span></p>
            	<p id="p_temperature_int">Affichage de la température intérieure: <span aria-live="assertive" id="span_temperature_int"></span></p>
				<div id="ValeurMaxMinInt">
					<p id="MaxInt">Value Maximale Intérieure: <span aria-live="assertive" id="span_tempmax_int"></span></p> 
					<p id="MinInt">Value Minimale Intérieure: <span aria-live="assertive" id="span_tempmin_int"></span></p> 
				</div>	
				<div id="ValeurMaxMinExt">
					<p id="MaxExt">Value Maximale Extérieure: <span aria-live="assertive" id="span_tempmax_ext"></span></p> 
					<p id="MinExt">Value Minimale Extérieure: <span aria-live="assertive" id="span_tempmin_ext"></span></p> 
				</div>
			</section>

			<!-- SECTION HISTORIQUE -->
			<section id="histo" >
				<table role="tabpanel" id="historique">
					<thead>
						<tr><th colspan="2">Historique</th></tr>
						<tr>
							<th>Date</th>
							<th>Température Intérieure</th>
							<th>Température Extérieure</th>
						</tr>
					</thead>
					<tbody id="tbody">
						<tr id="ligne_modele">
							<td class="td_date"></td>
							<td class="td_temperature_int"></td>
							<td class="td_temperature_ext"></td>
						</tr>
					</tbody>
				</table>
				<div id="Graph">
					<canvas id="myChart" width="400" height="400"></canvas>
				</div>
			</section>


			<!-- SECTION LOGIN 
			<section role="tabpanel" id="login">
				<p> Test login</p>
			</section> -->
		
			<!-- SECTION DOCUMENTATION -->
			<section role="tabpanel" id="doc">
				<p> Test doc</p>
			</section>

			<!-- BAS DE PAGE -->
			<footer>
				<h4>Bas de page</h4>
			</footer>
		</div>

		<script type="text/javascript">
			//Function pour afficher/cacher le menu
            function toggleMenu(){
                const contextMenu = document.getElementById("menu-box");
                if(contextMenu.style.display == "block"){
                    contextMenu.style.display = "none";
                }
                else{
                    contextMenu.style.display = "block"
                }
            }
            
			//Systemes d'onglets
            Array.from(document.querySelectorAll('nav ul li a')).forEach(function(element_a) {
				element_a.addEventListener('click', 
					function(event) {
						Array.from(document.querySelectorAll('.active')).forEach(function(element_section_ou_table) {
							element_section_ou_table.removeAttribute('class');
						});
						let element_a_id = event.target.attributes.href.value.replace('#', '');
						document.getElementById(element_a_id).setAttribute('class', 'active');
					}
				);
			});

			//Récupérer les valeurs de l'API
			function getDataAPI(){
				var socket = new WebSocket('wss://ws.hothothot.dog:9502');
            	socket.onopen = function(event) {

                	socket.send("test");

                	socket.onmessage = function(event){
						console.log("Connexion établie", typeof event.data);

                    	valueExt = event.data.capteurs[1][3];
                    	valueInt = event.data.capteurs[0][3];						
                	}	
           	 	}
				if(socket.readyState != 1){
					fetch("https://hothothot.dog/api/capteurs",
					{
						headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json'
						},
						method: "GET",
					})
					.then(function(response){
						response.json().then(data => {
							localStorage.setItem("ValeurInt", data.capteurs[0].Valeur);
							localStorage.setItem("ValeurExt", data.capteurs[1].Valeur);
							localStorage.setItem("TimeStamp", data.capteurs[0].Timestamp);
						})
					})
        		}
			}

			//Demander permission pour notifs push
			function askNotificationPermission() {
  				// La fonction qui sert effectivement à demander la permission
  				function handlePermission(permission) {
   					 // On affiche ou non le bouton en fonction de la réponse
    				if(Notification.permission === 'denied' || Notification.permission === 'default') {
      					notificationBtn.style.display = 'block';
    				} 
					else {
      					notificationBtn.style.display = 'none';
    				}
 				}

  				// Vérifions si le navigateur prend en charge les notifications
  				if (!('Notification' in window)) {
    				console.log("Ce navigateur ne prend pas en charge les notifications.");
  				} 
				else {
    				if(checkNotificationPromise()) {
      					Notification.requestPermission().then((permission) => {
        					handlePermission(permission);
      					})
    				} 
					else {
      					Notification.requestPermission(function(permission) {
        					handlePermission(permission);
      					});
    				}
  				}
			}

			//Création des configs pour les graphique 
			var canvas = document.getElementById("myChartInt");
			var data = {
				labels: [],
				datasets: [
					{
						label: 'Température Extérieure',
						backgroundColor: 'rgb(255, 99, 132)',
						borderColor: 'rgb(255, 99, 132)',
						data: [],
					},
					{
						label: "Température Intérieure",
						backgroundColor: 'rgb(99, 255, 132)',
						borderColor: 'rgb(99, 132, 255)',
						data: [],
					}
				]
			};
			
			var option = {
				showLines: true,
				responsive: false
			};

			const config = {
				type: 'line',
				data: data,
				options: option
			};

			const myChart = new Chart(document.getElementById("myChart"), config);

			var p_temperature_ext = document.getElementById('p_temperature_ext');
			var p_temperature_int = document.getElementById('p_temperature_int');

			var section_ext = p_temperature_ext.parentNode;
			var section_int = p_temperature_int.parentNode;
			
			var span_temperature_ext =  document.getElementById('span_temperature_ext');
			var span_temperature_int = document.getElementById('span_temperature_int');

			var span_tempmax_int = document.getElementById("span_tempmax_int");
			var span_tempmin_int = document.getElementById("span_tempmin_int");
			var span_tempmax_ext = document.getElementById("span_tempmax_ext");
			var span_tempmin_ext = document.getElementById("span_tempmin_ext");

			localStorage.setItem("ValeurMaxInt", 0);
			localStorage.setItem("ValeurMinInt", 50);
			localStorage.setItem("ValeurMaxExt", 0);
			localStorage.setItem("ValeurMinExt", 50);


			// https://developer.mozilla.org/en-US/docs/Web/API/setInterval
			var interval = setInterval(function(){
				if(document.getElementById('titre_message_int')) document.getElementById('titre_message_int').remove();
				if(document.getElementById('titre_message_ext')) document.getElementById('titre_message_ext').remove();	

				getDataAPI();

				var tempint = localStorage.getItem("ValeurInt");
				var tempext = localStorage.getItem("ValeurExt");
				var tempmaxint = localStorage.getItem("ValeurMaxInt");
				var tempminint = localStorage.getItem("ValeurMinInt");
				var tempmaxext = localStorage.getItem("ValeurMaxExt");
				var tempminext = localStorage.getItem("ValeurMinExt");

				if(tempint > tempmaxint){
					localStorage.setItem("ValeurMaxInt", tempint);
				}
				if(tempint < tempminint){
					localStorage.setItem("ValeurMinInt", tempint);
				}
				if(tempext > tempmaxext){
					localStorage.setItem("ValeurMaxExt", tempext);
				}
				if(tempext < tempminext){
					localStorage.setItem("ValeurMinExt", tempext);
				}

				var TimeStamp = localStorage.getItem("TimeStamp");
				var date = new Date(TimeStamp * 1000);

				//Système de couleur pour les températures
				let color = 'blue';

				if( 0 < tempint && tempint <= 20 ) {
					color = 'green';				
				}
				else if( 20 < tempint && tempint <= 30 ) {
					color = 'orange';
				}
				else if( 30 < tempint && tempint <= 40 ) {
					color = 'red';
				}

				span_temperature_int.setAttribute("class", color);
				span_temperature_int.innerText = tempint;

				span_temperature_ext.setAttribute("class", color);
				span_temperature_ext.innerText = tempext;

				span_tempmax_int.innerText = tempmaxint;
				span_tempmin_int.innerText = tempminint;
				span_tempmax_ext.innerText = tempmaxext;
				span_tempmin_ext.innerText = tempminext;


				//Système de notification intérieure

				let titre_message_int = document.createElement("h4");
				titre_message_int.setAttribute('id', 'titre_message_int');

				if( 22 < tempint) {
					titre_message_int.innerText = 'Baissez le chauffage !';
					const  notifications = new Notification ('HOthOT Hot',{body: 'Baissez le chauffage'});
				}
				else if ( 50 < tempint ) {
					titre_message_int.innerText = 'Appelez les pompiers ou arrêtez votre barbecue !';
					const  notifications2 = new Notification ('HOthOT Hot',{body: 'Appelez les pompiers ou arrêtez votre barbecue !'});
				}
				else if ( 12 > tempint ) {
					titre_message_int.innerText = 'Montez le chauffage ou mettez un gros pull  !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Montez le chauffage ou mettez un gros pull  !'});
				}
				else if ( 0 > tempint ) {
					titre_message_int.innerText = 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !'});
				}

				//Système de notification extérieure
				let titre_message_ext = document.createElement("h4");
				titre_message_ext.setAttribute('id', 'titre_message_ext');

				if( tempext < 0 ) {
					titre_message_ext.innerText = 'Banquise en vue !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !'});
        		} 
        		else if ( 35 < tempext ) {
            		titre_message_ext.innerText = 'Hot Hot Hot !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Hot Hot Hot !'});
        		}

				//Affichage notification
				section_ext.insertBefore(titre_message_ext, p_temperature_ext); 
				section_int.insertBefore(titre_message_int, p_temperature_int);


				// Gestion de l'historique
				var obj_the_table = document.getElementById("historique");

				if( obj_the_table.rows.length <  15) {
					let clone_historique_ligne = document.getElementById("ligne_modele").cloneNode(true);
					clone_historique_ligne.setAttribute("id", "");	
					clone_historique_ligne.querySelector(".td_date").innerText = Date().toString();
					clone_historique_ligne.querySelector(".td_temperature_int").innerText = tempint;
					clone_historique_ligne.querySelector(".td_temperature_ext").innerText = tempext;
					clone_historique_ligne.style.visibility = "visible";
					let table_tbody = document.querySelector("table tbody");
					// https://developer.mozilla.org/fr/docs/Web/API/Node/insertBefore
					table_tbody.insertBefore(clone_historique_ligne, table_tbody.querySelector("#ligne_modele").nextSibling);
				}
				else{
					for(var i = 2; i < obj_the_table.rows.length; i++){
						obj_the_table.deleteRow(i);
					}
					var tbody = document.getElementById("tbody");
					var ligne_modele = document.createElement("tr");
					ligne_modele.setAttribute("id", "ligne_modele");

					var td_date = document.createElement("td");
					td_date.setAttribute("class", "td_date");

					var td_temperature_int = document.createElement("td");
					td_temperature_int.setAttribute("class", "td_temperature_int");

					var td_temperature_ext = document.createElement("td");
					td_temperature_ext.setAttribute("class", "td_temperature_ext");

					tbody.appendChild(ligne_modele);
					ligne_modele.appendChild(td_date);
					ligne_modele.appendChild(td_temperature_int);
					ligne_modele.appendChild(td_temperature_ext);
				}
				// Mise à jour du graphe
				myChart.data.datasets[0].data.push(tempext);
				myChart.data.datasets[1].data.push(tempint);
				myChart.data.labels.push(date.getHours() + ":"+date.getMinutes() + ":"+date.getSeconds());

				if (myChart.data.datasets[0].data.length >= 30){	// Pas plus de 30 valeurs affichée en même temps
					myChart.data.labels = [];
    				myChart.data.datasets.forEach((dataset) => {
        				dataset.data = [];
    				});
				}
				myChart.update();

			}, 2500);
		</script>
	</body>
</html>