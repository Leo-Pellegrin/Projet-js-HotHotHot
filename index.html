<!doctype html>
<html>
	<head>
		<title>HotHotHot</title>
        <link rel="stylesheet" href="../Projet-js-HotHotHot/style.css">
		<script src="package/dist/chart.js"></script>
		<script src="js/TempModel.js" charset="utf-8"></script>
		<script src="js/TempObserver.js" charset="utf-8"></script>
		<script src="js/AlerteObserver.js" charset="utf-8"></script>
		<meta charset="utf-8"/>
	</head>
	<body>
		<div class="container">

			<!-- Menu de navigation -->
			<nav>
				<button id="menu" onclick="toggleMenu()">Menu</button>
				<ul id="menu-box" role="tablist">
					<li role="tab"><a href="#temp">Température</a></li>
					<li role="tab"><a href="#histo">Historique</a></li>
					<li role="tab"><a href="#login">Se connecter</a></li>
					<li role="tab"><a href="#doc">Documentation</a></li>
				</ul>
			</nav>

			<!-- Section Accueil -->
			<section id="acceuil">
				<h1>HotHotHot</h1>
				<p> Bonjour, Bienvenue sur notre site ! </p>
			</section>

			<!-- SECTION TEMPERATURE -->
        	<section role="tabpanel" class='active' id="temp">
				<p id="p_temperature_ext">Affichage de la température extérieure: <span aria-live="assertive" id="span_temperature_ext"></span></p>
            	<p id="p_temperature_int">Affichage de la température intérieure: <span aria-live="assertive" id="span_temperature_int"></span></p>
			</section>

			<!-- SECTION HISTORIQUE -->
			<section id="histo" >
				<table role="tabpanel" id="histo">
					<tr><th colspan="2">Historique</th></tr>
					<tr>
						<th>Date</th>
						<th>Température</th>
					</tr>
					<tr id="ligne_modele">
						<td class="td_date"></td>
						<td class="td_temperature"></td>
					</tr>
				</table>
				<div>
					<p id="MaxInt">Value Maximale Intérieure: <span aria-live="assertive" id="span_tempmax_int"></span></p> 
					<p id="MinInt">Value Minimale Intérieure: <span aria-live="assertive" id="span_tempmin_int"></span></p> 

					<p id="MaxExt">Value Maximale Extérieure: <span aria-live="assertive" id="span_tempmax_ext"></span></p> 
					<p id="MinExt">Value Minimale Extérieure: <span aria-live="assertive" id="span_tempmin_ext"></span></p> 

					<canvas id="myChart" width="400" height="400"></canvas>
				</div>		
			</section>


			<!-- SECTION LOGIN 
			<section role="tabpanel" id="login">
				<p> Test login</p>
			</section> -->
		
			<!-- SECTION DOCUMENTATION -->
			<section role="tabpanel" id="doc">
				<p> Test doc</p>
			</section>

			<!-- BAS DE PAGE -->
			<footer>
				<h4>Bas de page</h4>
			</footer>
		</div>

		<script type="text/javascript">
			//Function pour afficher/cacher le menu
            function toggleMenu(){
                const contextMenu = document.getElementById("menu-box");
                if(contextMenu.style.display == "block"){
                    contextMenu.style.display = "none";
                }
                else{
                    contextMenu.style.display = "block"
                }
            }
            
			//Systemes d'onglets
            Array.from(document.querySelectorAll('nav ul li a')).forEach(function(element_a) {
				element_a.addEventListener('click', 
					function(event) {
						Array.from(document.querySelectorAll('.active')).forEach(function(element_section_ou_table) {
							element_section_ou_table.removeAttribute('class');
						});
						let element_a_id = event.target.attributes.href.value.replace('#', '');
						document.getElementById(element_a_id).setAttribute('class', 'active');
					}
				);
			});

			//Récupérer les valeurs de l'API
			function getDataAPI(){
				var socket = new WebSocket('wss://ws.hothothot.dog:9502');
            	socket.onopen = function(event) {
                	console.log("Connexion établie", event.data[capteurs][0][valeur]);

                	socket.send("test");

                	socket.onmessage = function(event){
                    	valueExt = event.data.capteurs[1][3];
                    	valueInt = event.data.capteurs[0][3];						
						return valueExt, valueInt;
                	}	
           	 	}
				if(socket.readyState != 1){
					fetch("https://hothothot.dog/api/capteurs",
					{
						headers: {
							'Accept': 'application/json',
							'Content-Type': 'application/json'
						},
						method: "GET",
					})
					.then(function(response){
						console.log("API par fetch", response.json());
						return response.json();
					})
        		}
			}

			//Demander permission pour notifs
			function askNotificationPermission() {
  				// La fonction qui sert effectivement à demander la permission
  				function handlePermission(permission) {
   					 // On affiche ou non le bouton en fonction de la réponse
    				if(Notification.permission === 'denied' || Notification.permission === 'default') {
      					notificationBtn.style.display = 'block';
    				} 
					else {
      					notificationBtn.style.display = 'none';
    				}
 				}

  				// Vérifions si le navigateur prend en charge les notifications
  				if (!('Notification' in window)) {
    				console.log("Ce navigateur ne prend pas en charge les notifications.");
  				} 
				else {
    				if(checkNotificationPromise()) {
      					Notification.requestPermission().then((permission) => {
        					handlePermission(permission);
      					})
    				} 
					else {
      					Notification.requestPermission(function(permission) {
        					handlePermission(permission);
      					});
    				}
  				}
			}

			//Création des configs pour les graphique 
			var canvas = document.getElementById("myChartInt");
			var data = {
				labels: ["0h", "2h", "4h", "6h", "8h", "10h", "12h"],
				datasets: [
					{
						label: 'My First dataset',
						backgroundColor: 'rgb(255, 99, 132)',
						borderColor: 'rgb(255, 99, 132)',
						data: [],
					},
					{
						label: "My Second dataset",
						backgroundColor: 'rgb(99, 255, 132)',
						borderColor: 'rgb(99, 132, 255)',
						data: [],
					}
				]
			};
			
			var option = {
				showLines: true,
				responsive: false
			};

			const config = {
				type: 'line',
				data: data,
				options: option
			};

			const myChart = new Chart(document.getElementById("myChartInt"), config);

			var p_temperature_ext = document.getElementById('p_temperature_ext');
			var p_temperature_int = document.getElementById('p_temperature_int');

			var section_ext = p_temperature_ext.parentNode;
			var section_int = p_temperature_int.parentNode;
			
			var span_temperature_ext =  document.getElementById('span_temperature_ext');
			var span_temperature_int = document.getElementById('span_temperature_int');

			var span_tempmax_int = document.getElementById("span_tempmax_int");
			var span_tempmin_int = document.getElementById("span_tempmin_int");
			var span_tempmax_ext = document.getElementById("span_tempmax_ext");
			var span_tempmin_ext = document.getElementById("span_tempmin_ext");

			// https://developer.mozilla.org/en-US/docs/Web/API/setInterval
			var interval = setInterval(function(){
				if(document.getElementById('titre_message_int')) document.getElementById('titre_message_int').remove();
				if(document.getElementById('titre_message_ext')) document.getElementById('titre_message_ext').remove();	

				var tempint, tempext = getDataAPI();

				//Système de couleur pour les températures
				let color = 'blue';

				if( 0 < tempint && tempint <= 20 ) {
					color = 'green';				
				}
				else if( 20 < tempint && tempint <= 30 ) {
					color = 'orange';
				}
				else if( 30 < tempint && tempint <= 40 ) {
					color = 'red';
				}

				span_temperature_int.setAttribute("class", color);
				span_temperature_int.innerText = I_temperature;

				span_temperature_ext.setAttribute("class", color);
				span_temperature_ext.innerText = I_temperature;

				//Système de notification intérieure

				let titre_message_int = document.createElement("h4");
				titre_message_int.setAttribute('id', 'titre_message_int');

				if( 22 < tempint) {
					titre_message_int.innerText = 'Baissez le chauffage !';
					const  notifications = new Notification ('HOthOT Hot',{body: 'Baissez le chauffage'});
					
					titre_message_int.innerText = 'Appelez les pompiers ou arrêtez votre barbecue !';
					const  notifications1 = new Notification ('HOthOT Hot',{body: 'Appelez les pompiers ou arrêtez votre barbecue'});
				}
				else if ( 50 < tempint ) {
					titre_message_int.innerText = 'Appelez les pompiers ou arrêtez votre barbecue !';
					const  notifications2 = new Notification ('HOthOT Hot',{body: 'Appelez les pompiers ou arrêtez votre barbecue !'});
				}
				else if ( 12 > tempint ) {
					titre_message_int.innerText = 'Montez le chauffage ou mettez un gros pull  !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Montez le chauffage ou mettez un gros pull  !'});
				}
				else if ( 0 > tempint ) {
					titre_message_int.innerText = 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !'});
				}

				//Système de notification extérieure
				let titre_message_ext = document.createElement("h4");
				titre_message_ext.setAttribute('id', 'titre_message_ext');

				if( tempext < 0 ) {
					titre_message_ext.innerText = 'Banquise en vue !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Canalisations gelées, appelez SOS plombier et mettez un bonnet !'});
        		} 
        		else if ( 35 < tempext ) {
            		titre_message_ext.innerText = 'Hot Hot Hot !';
					const  notifications3 = new Notification ('HOthOT Hot',{body: 'Hot Hot Hot !'});
        		}

				// Gestion de l'historique
				section_ext.insertBefore(titre_message_ext, p_temperature_ext); 
				section_int.insertBefore(titre_message_int, p_temperature_int);

				let clone_historique_ligne = document.getElementById("ligne_modele").cloneNode(true);
				clone_historique_ligne.setAttribute("id", "");	
				clone_historique_ligne.querySelector(".td_date").innerText = Date().toString();
				clone_historique_ligne.querySelector(".td_temperature").innerText = I_temperature;
				clone_historique_ligne.style.visibility = "visible";
				let table_tbody = document.querySelector("table tbody");
				// https://developer.mozilla.org/fr/docs/Web/API/Node/insertBefore
				table_tbody.insertBefore(clone_historique_ligne, table_tbody.querySelector("#ligne_modele").nextSibling);

				// Mise à jour du graphe
				myChart.data.datasets[0].data.push(model.tempext);
				myChart.data.datasets[1].data.push(model.tempint);
				myChart.data.labels.push("Newly added");
				myChart.update();

			}, 2000);
		</script>
	</body>
</html>